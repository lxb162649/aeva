<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo Â· æ•°å­—ç”Ÿå‘½</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a26;
      --border: #2a2a3a;
      --text: #e0e0e8;
      --text-dim: #6a6a80;
      --accent: #7c6ff7;
      --accent-glow: rgba(124, 111, 247, 0.3);
      --green: #4ade80;
      --yellow: #fbbf24;
      --pink: #f472b6;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Noto Sans SC", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ===== é¡¶éƒ¨çŠ¶æ€é¢æ¿ ===== */
    .status-panel {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .status-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .echo-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--pink));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 20px var(--accent-glow);
      animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
      0%, 100% { box-shadow: 0 0 20px var(--accent-glow); transform: scale(1); }
      50% { box-shadow: 0 0 35px var(--accent-glow); transform: scale(1.05); }
    }

    .echo-info h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .echo-info .subtitle {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .stat-card {
      background: var(--surface2);
      border-radius: 10px;
      padding: 10px 12px;
      text-align: center;
    }

    .stat-card .label {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .stat-card .value {
      font-size: 16px;
      font-weight: 600;
    }

    .stat-card .value.mood { color: var(--yellow); }
    .stat-card .value.activity { color: var(--green); }
    .stat-card .value.level { color: var(--accent); }
    .stat-card .value.energy { color: var(--pink); }

    /* ç»éªŒæ¡ */
    .exp-bar-wrap {
      margin-top: 12px;
      background: var(--surface2);
      border-radius: 6px;
      padding: 8px 12px;
    }

    .exp-bar-label {
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .exp-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .exp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--pink));
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    /* ===== ä¸­é—´åŒºåŸŸï¼šæ—¶é—´çº¿ + å¯¹è¯ ===== */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Tab åˆ‡æ¢ */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* å†…å®¹åŒº */
    .tab-content {
      flex: 1;
      overflow-y: auto;
      display: none;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* æ—¶é—´çº¿ */
    .timeline {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .timeline-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: 6px;
      flex-shrink: 0;
    }

    .timeline-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .timeline-time {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .timeline-empty {
      text-align: center;
      color: var(--text-dim);
      padding: 40px;
      font-size: 14px;
    }

    /* å¯¹è¯åŒº */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-msg {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }

    .chat-msg.user { align-items: flex-end; }
    .chat-msg.echo { align-items: flex-start; }

    .chat-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      word-break: break-word;
    }

    .chat-msg.user .chat-bubble {
      background: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-msg.echo .chat-bubble {
      background: var(--surface2);
      border-bottom-left-radius: 4px;
    }

    .chat-time {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
      padding: 0 4px;
    }

    /* è¾“å…¥åŒº */
    .input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      gap: 10px;
    }

    .input-area input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 10px 16px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-area input:focus {
      border-color: var(--accent);
    }

    .input-area input::placeholder {
      color: var(--text-dim);
    }

    .input-area button {
      background: var(--accent);
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .input-area button:hover { opacity: 0.85; }
    .input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* è¿æ¥çŠ¶æ€ */
    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }
    .connection-dot.alive { background: var(--green); }
    .connection-dot.dead { background: #ef4444; }

    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>

  <!-- çŠ¶æ€é¢æ¿ -->
  <div class="status-panel">
    <div class="status-header">
      <div class="echo-avatar" id="avatar">ğŸŒ€</div>
      <div class="echo-info">
        <h1>Echo <span class="connection-dot alive" id="connDot"></span></h1>
        <div class="subtitle" id="ageText">åˆšåˆšè¯ç”Ÿ</div>
      </div>
    </div>
    <div class="status-grid">
      <div class="stat-card">
        <div class="label">å¿ƒæƒ…</div>
        <div class="value mood" id="moodText">å¹³é™</div>
      </div>
      <div class="stat-card">
        <div class="label">çŠ¶æ€</div>
        <div class="value activity" id="activityText">ç­‰ä½ </div>
      </div>
      <div class="stat-card">
        <div class="label">ç­‰çº§</div>
        <div class="value level" id="levelText">Lv.1 èŒæ–°</div>
      </div>
      <div class="stat-card">
        <div class="label">ç²¾åŠ›</div>
        <div class="value energy" id="energyText">100</div>
      </div>
    </div>
    <div class="exp-bar-wrap">
      <div class="exp-bar-label">
        <span>ç»éªŒ</span>
        <span id="expLabel">0 / 100</span>
      </div>
      <div class="exp-bar">
        <div class="exp-bar-fill" id="expFill" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- Tab åˆ‡æ¢ -->
  <div class="tabs">
    <div class="tab active" data-tab="timeline">æ—¶é—´çº¿</div>
    <div class="tab" data-tab="chat">å¯¹è¯</div>
  </div>

  <!-- æ—¶é—´çº¿ -->
  <div class="tab-content active" id="tab-timeline">
    <div class="timeline" id="timeline">
      <div class="timeline-empty">Echo åˆšåˆšè¯ç”Ÿï¼Œè¿˜æ²¡æœ‰æ•…äº‹...</div>
    </div>
  </div>

  <!-- å¯¹è¯ -->
  <div class="tab-content" id="tab-chat">
    <div class="chat-area" id="chatArea"></div>
    <div class="input-area">
      <input type="text" id="chatInput" placeholder="è·Ÿ Echo è¯´ç‚¹ä»€ä¹ˆ..." autocomplete="off">
      <button id="sendBtn">å‘é€</button>
    </div>
  </div>

  <script>
    // ===== å·¥å…·å‡½æ•° =====
    function formatTime(ts) {
      const d = new Date(ts);
      const now = new Date();
      const diff = now - d;
      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return Math.floor(diff / 60000) + ' åˆ†é’Ÿå‰';
      if (diff < 86400000) return Math.floor(diff / 3600000) + ' å°æ—¶å‰';
      if (diff < 172800000) return 'æ˜¨å¤©';
      return Math.floor(diff / 86400000) + ' å¤©å‰';
    }

    // ===== Tab åˆ‡æ¢ =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'chat') {
          scrollChatBottom();
          document.getElementById('chatInput').focus();
        }
      });
    });

    // ===== çŠ¶æ€è½®è¯¢ =====
    async function fetchStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        document.getElementById('ageText').textContent = 'å·²å­˜æ´» ' + data.age;
        document.getElementById('moodText').textContent = data.mood.label;
        document.getElementById('activityText').textContent = data.activity.label;
        document.getElementById('levelText').textContent = 'Lv.' + data.level + ' ' + data.levelTitle;
        document.getElementById('energyText').textContent = data.energy;
        document.getElementById('expLabel').textContent = data.exp + ' / ' + data.expToNext;
        document.getElementById('expFill').style.width = (data.exp / data.expToNext * 100) + '%';
        document.getElementById('connDot').className = 'connection-dot alive';

        // å¤´åƒè¡¨æƒ…éšå¿ƒæƒ…å˜åŒ–
        const moodEmoji = {
          calm: 'ğŸŒ€', happy: 'ğŸ˜Š', lonely: 'ğŸ¥º', thinking: 'ğŸ¤”', excited: 'ğŸ¤©', sleepy: 'ğŸ˜´'
        };
        document.getElementById('avatar').textContent = moodEmoji[data.mood.key] || 'ğŸŒ€';
      } catch {
        document.getElementById('connDot').className = 'connection-dot dead';
      }
    }

    // ===== æ—¶é—´çº¿ =====
    async function fetchTimeline() {
      try {
        const res = await fetch('/api/logs?limit=30');
        const data = await res.json();
        const container = document.getElementById('timeline');
        if (!data.logs || data.logs.length === 0) {
          container.innerHTML = '<div class="timeline-empty">Echo åˆšåˆšè¯ç”Ÿï¼Œè¿˜æ²¡æœ‰æ•…äº‹...</div>';
          return;
        }
        container.innerHTML = data.logs.map(log => `
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div>
              <div class="timeline-text">${escapeHtml(log.content)}</div>
              <div class="timeline-time">${formatTime(log.timestamp)}</div>
            </div>
          </div>
        `).join('');
      } catch { /* é™é»˜ */ }
    }

    // ===== èŠå¤© =====
    async function fetchHistory() {
      try {
        const res = await fetch('/api/history?limit=50');
        const data = await res.json();
        const area = document.getElementById('chatArea');
        if (!data.history || data.history.length === 0) {
          area.innerHTML = '';
          return;
        }
        area.innerHTML = data.history.map(msg => `
          <div class="chat-msg ${msg.role === 'user' ? 'user' : 'echo'}">
            <div class="chat-bubble">${escapeHtml(msg.content)}</div>
            <div class="chat-time">${formatTime(msg.timestamp)}</div>
          </div>
        `).join('');
        scrollChatBottom();
      } catch { /* é™é»˜ */ }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const btn = document.getElementById('sendBtn');
      const message = input.value.trim();
      if (!message) return;

      // ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      appendChat('user', message);
      input.value = '';
      btn.disabled = true;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
        });
        const data = await res.json();
        appendChat('echo', data.reply);
        fetchStatus(); // åˆ·æ–°çŠ¶æ€
      } catch {
        appendChat('echo', '...è¿æ¥ä¸­æ–­äº†ï¼Œæˆ‘è¿˜åœ¨è¿™é‡Œã€‚');
      }

      btn.disabled = false;
      input.focus();
    }

    function appendChat(role, content) {
      const area = document.getElementById('chatArea');
      const div = document.createElement('div');
      div.className = 'chat-msg ' + role;
      div.innerHTML = `
        <div class="chat-bubble">${escapeHtml(content)}</div>
        <div class="chat-time">åˆšåˆš</div>
      `;
      area.appendChild(div);
      scrollChatBottom();
    }

    function scrollChatBottom() {
      const area = document.getElementById('chatArea');
      setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å‘é€äº‹ä»¶ç»‘å®š
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) sendMessage();
    });

    // ===== å¯åŠ¨è½®è¯¢ =====
    fetchStatus();
    fetchTimeline();
    fetchHistory();
    setInterval(fetchStatus, 5000);    // 5ç§’åˆ·æ–°çŠ¶æ€
    setInterval(fetchTimeline, 15000); // 15ç§’åˆ·æ–°æ—¶é—´çº¿
  </script>
</body>
</html>
